/*! toby 2015-06-27 */
var Toby=function(){"use strict";var a=require("fs"),b=require("path"),c=require("remote"),d=require("shell"),e=c.getCurrentWindow(),f=__dirname+b.sep,g=f+["data","data.json"].join(b.sep),h=f+["data","recent.json"].join(b.sep),i="Toby - A YouTube player for the desktop",j=function(){var a,b={},c=[],d=require("socket.io")();b.send=function(b,c){void 0!==a&&a.emit(b,c)},b.on=function(a,b){c.push({type:a,func:b})};var e=function(a,b){c.length>0&&_.forEach(_.where(c,{type:a}),function(a){void 0!==b&&void 0!==a.func?a.func(b):a.func()})};return d.on("connection",function(b){b.on("video-info",function(a){e("video-info",a)}),b.on("youtube-api-ready",function(){a=b,e("youtube-api-ready")}),b.on("youtube-player-state-changed",function(a){e("youtube-player-state-changed",a)})}),d.listen(5150),b}(),k=function(b){try{var c=a.readFileSync(b);c=JSON.parse(c.toString());var d=_.flatten(_.pluck(c,"videos")),e=[];return _.forEach(d,function(a){e.push({description:a.description,ytid:a.ytid,url:"http://youtube.com/embed/"+a.ytid})}),{videoData:c,videos:e}}catch(f){return{videoData:[],videos:[]}}},l=function(b){if(!a.existsSync(b))return[];try{var c=a.readFileSync(b);return JSON.parse(c.toString())}catch(d){return console.log("error loading recently played from file: "+d),[]}},m=React.createClass({displayName:"VideoSearch",getInitialState:function(){return{searchResults:[],recentlyPlayedData:l(h),searchListStyle:{display:"block"},searchResultsStyle:{display:"none"},recentlyPlayedStyle:{display:"none"},webviewStyle:{visibility:"hidden"},data:k(g),currentVideoSrc:"",currentVideoTitle:"",currentVideoId:"",newVideoNotification:""}},componentDidMount:function(){window.onkeydown=this.handleKeyDown,e.setTitle(i);var b=this.refs.searchResults.getDOMNode(),c=this.refs.searchBox.getDOMNode(),d=function(){var a=e.getContentSize();b.style.height=a[1]-100+"px",c.style.width=a[0]-20+"px"};d(),window.addEventListener("resize",function(a){d()}.bind(this)),a.watchFile(g,function(a,b){this.setState({data:k(g)})}.bind(this)),this.state.recentlyPlayedData.length>0&&this.setState({recentlyPlayedStyle:{display:"block"}}),this.state.recentlyPlayedData=_.forEach(this.state.recentlyPlayedData,function(a){a.playVideo=this.setPlayVideoState(a)}.bind(this))},setPlayVideoState:function(a){return function(){j.send("play",a.ytid),this.setState({currentVideoSrc:a.url,webviewStyle:{visibility:"visible"},searchListStyle:{display:"none"}})}.bind(this)},addToRecentlyPlayedList:function(a){var b=_.find(this.state.recentlyPlayedData,function(b){return a.ytid===b.ytid?b:void 0});void 0===b&&(this.state.recentlyPlayedData=_.takeRight(this.state.recentlyPlayedData,25),this.state.recentlyPlayedData.push({description:a.description,url:a.url,ytid:a.ytid,playVideo:this.setPlayVideoState(a)}))},handleSearch:function(a){var b=[],c=a.target.value,d=a.target.value.toLowerCase();if(0===d.length)return this.setState({searchResultData:[],searchResultsStyle:{display:"none"}}),void(this.state.recentlyPlayedData.length>0&&this.setState({recentlyPlayedStyle:{display:"block"}}));if("%all%"===d)b=this.state.data.videos.slice(0);else if("%"===d.charAt(0)&&"%"===d.slice(-1)){var e=_.find(this.state.data.videoData,function(a){return d==="%"+a.title.toLowerCase()+"%"});void 0!==e&&(b=e.videos.slice(0))}else b=_.filter(this.state.data.videos,function(a){return a.description.toLowerCase().includes(d)});0!==b.length||d.startsWith("%")||b.push({description:"Play video with ID: "+c,url:"https://www.youtube.com/embed/"+c,ytid:c}),b.length>0?this.setState({searchResults:b,searchResultsStyle:{display:"block"},recentlyPlayedStyle:{display:"none"}}):(this.setState({searchResultsStyle:{display:"none"}}),this.state.recentlyPlayedData.length>0&&(recentlyPlayedStyle.display="flex"))},clearSearchBox:function(){var a=this.refs.searchBox.getDOMNode();a.value.length>0&&(a.value="")},handleClick:function(a){var b=a.target.dataset.url+"?autoplay=1",c=a.target.text,d=a.target.dataset.ytid;this.addToRecentlyPlayedList({description:c,url:b,ytid:d}),j.send("play",d),this.setState({searchResults:[],currentVideoSrc:b,currentVideoTitle:c,currentVideoId:d,searchListStyle:{display:"none"},searchResultsStyle:{display:"none"},recentlyPlayedStyle:{display:"block"},webviewStyle:{visibility:"visible"}}),this.clearSearchBox()},handleKeyDown:function(a){switch(a.keyCode){case 112:this.toggleSearchPlayListAndWebview();break;case 116:this.addCurrentVideoToDataJson();break;case 121:e.reload();break;case 123:e.openDevTools()}},toggleSearchPlayListAndWebview:function(a){if(""!==this.state.currentVideoSrc)if("block"===this.state.searchListStyle.display)this.setState({searchListStyle:{display:"none"},searchResultsStyle:{display:"none"},webviewStyle:{visibility:"visible"}}),e.setTitle(this.state.currentVideoTitle),this.clearSearchBox();else{var b="none";this.state.recentlyPlayedData.length>0&&(b="block"),this.setState({searchListStyle:{display:"block"},recentlyPlayedStyle:{display:b},webviewStyle:{visibility:"hidden"}}),e.setTitle(i)}},addCurrentVideoToDataJson:function(){var b=this.state.data.videoData.slice(0);if(""!==this.state.currentVideoSrc&&""!==this.state.currentVideoTitle&&""!==this.state.currentVideoId){var c={description:this.state.currentVideoTitle,ytid:this.state.currentVideoId},d=_.find(b,function(a){return"misc"===a.title});if(void 0===d){var d={title:"misc",videos:[]};b.push(d)}var e=_.find(this.state.data.videos,function(a){return a.ytid===c.ytid});if(void 0===e){d.videos.push(c);var b=_.filter(b,function(a){return"misc"!==a.title});b.push(d),this.setState({newVideoNotification:"Added: "+c.description}),setTimeout(function(){this.setState({newVideoNotification:""})}.bind(this),1e3)}a.writeFile(g,JSON.stringify(b,void 0,2),function(a){if(a)throw a})}},updateTitle:function(b,c){this.setState({currentVideoTitle:b,currentVideoId:c});var d=_.find(this.state.recentlyPlayedData,{ytid:c});void 0!==d?(d.description=b,this.state.recentlyPlayedData=_.forEach(this.state.recentlyPlayedData,function(a){return a.url=a.url.replace("?autoplay=1","")}),a.writeFile(h,JSON.stringify(this.state.recentlyPlayedData,void 0,2),function(a){if(a)throw a})):this.addToRecentlyPlayedList({description:b,url:"http://youtube.com/embed/"+c,ytid:c})},render:function(){var a=this.handleClick.bind(this);return React.createElement("div",{id:"main-content"},React.createElement("div",{id:"searchList",ref:"searchList",style:this.state.searchListStyle},React.createElement("input",{type:"text",ref:" searchBox",id:"searchBox",ref:"searchBox",placeholder:"search your videos or enter youtube id...",onChange:this.handleSearch}),React.createElement("div",{id:"searchResults",ref:"searchResults",style:this.state.searchResultsStyle},this.state.searchResults.sort(function(a,b){return a.description<b.description?-1:a.description>b.description?1:0}).map(function(b){return React.createElement("span",null,React.createElement("a",{href:"#","data-url":b.url,"data-ytid":b.ytid,onClick:a},b.description),React.createElement("br",null))})),React.createElement(n,{data:this.state.recentlyPlayedData,style:this.state.recentlyPlayedStyle})),React.createElement(o,{src:this.state.currentVideoSrc,title:this.state.currentVideoTitle,style:this.state.webviewStyle,updateTitle:this.updateTitle}),React.createElement(p,{message:this.state.newVideoNotification}))}}),n=React.createClass({displayName:"RecentlyPlayedList",componentDidMount:function(){window.addEventListener("resize",function(a){this.resize()}.bind(this)),this.resize()},resize:function(){var a=e.getContentSize(),b=this.refs.recentlyPlayed.getDOMNode(),c=this.refs.recentlyPlayedList.getDOMNode();b.style.width=a[0]-30+"px",c.style.height=a[1]-126+"px"},render:function(){return React.createElement("div",{id:"recentlyPlayed",ref:"recentlyPlayed",style:this.props.style},React.createElement("div",{id:"recentlyPlayedHeader"},"Recently Played"),React.createElement("div",{id:"recentlyPlayedList",ref:"recentlyPlayedList"},this.props.data.sort(function(a,b){return a.description<b.description?-1:a.description>b.description?1:0}).map(function(a){return React.createElement("span",null,React.createElement("a",{href:"#","data-url":a.url,onClick:a.playVideo},a.description),React.createElement("br",null))})))}}),o=React.createClass({displayName:"VideoPlayback",componentDidMount:function(){var a=this.refs.webview.getDOMNode();a.addEventListener("new-window",function(a){d.openExternal(a.url)}),j.on("video-info",function(a){e.setTitle(a.title),void 0!==this.state.updateTitle&&this.state.updateTitle(a.title,a.video_id)}.bind(this)),setInterval(function(){"visible"===a.style.visibility&&a.send("ping")}.bind(this),1e3)},componentWillReceiveProps:function(a){void 0!==this.props.updateTitle&&this.setState({updateTitle:this.props.updateTitle})},render:function(){return React.createElement("div",null,React.createElement("webview",{id:"webview",ref:"webview",src:"./player.html",style:this.props.style}))}}),p=React.createClass({displayName:"Notification",getInitialState:function(){return{notificationStyle:{display:"none"},message:this.props.message}},componentWillReceiveProps:function(a){a.message.length>0&&(this.setState({notificationStyle:{display:"block"},message:a.message}),setTimeout(function(){this.setState({notificationStyle:{display:"none"},message:""})}.bind(this),2500))},render:function(){return React.createElement("div",{id:"notification",style:this.state.notificationStyle},this.state.message)}});return{init:function(){React.render(React.createElement(m,null),document.getElementById("ui")),j.on("youtube-api-ready",function(){var a=$("#main-content");a.css("visibility","visible"),$("#loading").fadeOut("fast"),a.hide().fadeIn("slow")})}}}();$(document).ready(function(){Toby.init()});
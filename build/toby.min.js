/*! toby 2015-06-17 */
var Toby=function(){"use strict";var a=require("fs"),b=require("path"),c=require("remote"),d=require("shell"),e=c.getCurrentWindow(),f=__dirname+b.sep+["data","data.json"].join(b.sep),g=__dirname+b.sep+["data","recent.json"].join(b.sep),h="Toby - A YouTube player for the desktop",i=function(b){try{var c=a.readFileSync(b);c=JSON.parse(c.toString());var d=_.flatten(_.pluck(c,"videos")),e=[];return _.forEach(d,function(a){e.push({description:a.description,ytid:a.ytid,url:"http://youtube.com/embed/"+a.ytid})}),{videoData:c,videos:e}}catch(f){return{videoData:[],videos:[]}}},j=function(b){if(!a.existsSync(b))return[];try{var c=a.readFileSync(b);return JSON.parse(c.toString())}catch(d){return console.log("error loading recently played from file: "+d),[]}},k=React.createClass({displayName:"VideoSearch",getInitialState:function(){return{searchResults:[],recentlyPlayedData:j(g),searchListStyle:{display:"block"},searchResultsStyle:{display:"none"},recentlyPlayedStyle:{display:"none"},webviewStyle:{visibility:"hidden"},data:i(f),currentVideoSrc:"",currentVideoTitle:"",currentVideoId:""}},componentDidMount:function(){window.onkeydown=this.handleKeyDown,e.setTitle(h);var b=this.refs.searchResults.getDOMNode(),c=this.refs.searchBox.getDOMNode(),d=function(){var a=e.getContentSize();b.style.height=a[1]-100+"px",c.style.width=a[0]-20+"px"};d(),window.addEventListener("resize",function(a){d()}.bind(this)),a.watchFile(f,function(a,b){this.setState({data:i(f)})}.bind(this)),this.state.recentlyPlayedData.length>0&&this.setState({recentlyPlayedStyle:{display:"block"}}),this.state.recentlyPlayedData=_.forEach(this.state.recentlyPlayedData,function(a){a.playVideo=this.setPlayVideoState(a)}.bind(this))},setPlayVideoState:function(a){return function(){a.url.endsWith("?autoplay=1")||(a.url=a.url.concat("?autoplay=1")),this.setState({currentVideoSrc:a.url,webviewStyle:{visibility:"visible"},searchListStyle:{display:"none"}})}.bind(this)},addToRecentlyPlayedList:function(a){var b=_.find(this.state.recentlyPlayedData,function(b){return a.description===b.description?b:void 0});void 0===b&&(this.state.recentlyPlayedData=_.takeRight(this.state.recentlyPlayedData,25),this.state.recentlyPlayedData.push({description:a.description,url:a.url,ytid:a.ytid,playVideo:this.setPlayVideoState(a)}))},handleSearch:function(a){var b=[],c=a.target.value,d=a.target.value.toLowerCase();if(0===d.length)return this.setState({searchResultData:[],searchResultsStyle:{display:"none"}}),void(this.state.recentlyPlayedData.length>0&&this.setState({recentlyPlayedStyle:{display:"block"}}));if("%all%"===d)b=this.state.data.videos.slice(0);else if("%"===d.charAt(0)&&"%"===d.slice(-1)){var e=_.find(this.state.data.videoData,function(a){return d==="%"+a.title.toLowerCase()+"%"});void 0!==e&&(b=e.videos.slice(0))}else b=_.filter(this.state.data.videos,function(a){return a.description.toLowerCase().includes(d)});0!==b.length||d.startsWith("%")||b.push({description:"Play video with ID: "+c,url:"https://www.youtube.com/embed/"+c,ytid:c}),b.length>0?this.setState({searchResults:b,searchResultsStyle:{display:"block"},recentlyPlayedStyle:{display:"none"}}):(this.setState({searchResultsStyle:{display:"none"}}),this.state.recentlyPlayedData.length>0&&(recentlyPlayedStyle.display="flex"))},clearSearchBox:function(){var a=this.refs.searchBox.getDOMNode();a.value.length>0&&(a.value="")},handleClick:function(a){var b=a.target.dataset.url+"?autoplay=1",c=a.target.text,d=a.target.dataset.ytid;this.addToRecentlyPlayedList({description:c,url:b,ytid:d}),this.setState({searchResults:[],currentVideoSrc:b,currentVideoTitle:c,currentVideoId:d,searchListStyle:{display:"none"},searchResultsStyle:{display:"none"},recentlyPlayedStyle:{display:"block"},webviewStyle:{visibility:"visible"}}),this.clearSearchBox()},handleKeyDown:function(a){switch(a.keyCode){case 112:this.toggleSearchPlayListAndWebview();break;case 114:e.reload();break;case 116:this.addCurrentVideoToDataJson();break;case 123:e.openDevTools()}},toggleSearchPlayListAndWebview:function(a){""!==this.state.currentVideoSrc&&("block"===this.state.searchListStyle.display?(this.setState({searchListStyle:{display:"none"},webviewStyle:{visibility:"visible"}}),e.setTitle(this.state.currentVideoTitle),this.clearSearchBox()):(this.setState({searchListStyle:{display:"block"},webviewStyle:{visibility:"hidden"}}),e.setTitle(h)))},addCurrentVideoToDataJson:function(){var b=this.state.data.videoData.slice(0);if(""!==this.state.currentVideoSrc){var c={description:this.state.currentVideoTitle,ytid:this.state.currentVideoId},d=_.find(b,function(a){return"misc"===a.title});if(void 0===d){var d={title:"misc",videos:[]};b.push(d)}var e=_.find(this.state.data.videos,function(a){return a.ytid===c.ytid});if(void 0===e){d.videos.push(c);var b=_.filter(b,function(a){return"misc"!==a.title});b.push(d)}a.writeFile(f,JSON.stringify(b,void 0,2),function(a){if(a)throw a})}},updateTitle:function(b,c){this.setState({currentVideoTitle:b,currentVideoId:c});var d=_.find(this.state.recentlyPlayedData,{ytid:c});void 0!==d?(d.description=b,this.state.recentlyPlayedData=_.forEach(this.state.recentlyPlayedData,function(a){return a.url=a.url.replace("?autoplay=1","")}),a.writeFile(g,JSON.stringify(this.state.recentlyPlayedData,void 0,2),function(a){if(a)throw a})):this.addToRecentlyPlayedList({description:b,url:"http://youtube.com/embed/"+c,ytid:c})},render:function(){var a=this.handleClick.bind(this);return React.createElement("div",null,React.createElement("div",{id:"searchList",ref:"searchList",style:this.state.searchListStyle},React.createElement("input",{type:"text",ref:" searchBox",id:"searchBox",ref:"searchBox",placeholder:"search videos or enter youtube id...",onChange:this.handleSearch}),React.createElement("div",{id:"searchResults",ref:"searchResults",style:this.state.searchResultsStyle},this.state.searchResults.sort(function(a,b){return a.description<b.description?-1:a.description>b.description?1:0}).map(function(b){return React.createElement("span",null,React.createElement("a",{href:"#","data-url":b.url,"data-ytid":b.ytid,onClick:a},b.description),React.createElement("br",null))})),React.createElement(l,{data:this.state.recentlyPlayedData,style:this.state.recentlyPlayedStyle})),React.createElement(m,{src:this.state.currentVideoSrc,title:this.state.currentVideoTitle,style:this.state.webviewStyle,updateTitle:this.updateTitle}))}}),l=React.createClass({displayName:"RecentlyPlayedList",componentDidMount:function(){window.addEventListener("resize",function(a){this.resize()}.bind(this)),this.resize()},resize:function(){var a=e.getContentSize(),b=this.refs.recentlyPlayed.getDOMNode(),c=this.refs.recentlyPlayedList.getDOMNode();b.style.width=a[0]-30+"px",c.style.height=a[1]-138+"px"},render:function(){return React.createElement("div",{id:"recentlyPlayed",ref:"recentlyPlayed",style:this.props.style},React.createElement("div",{id:"recentlyPlayedHeader"},"Recently Played"),React.createElement("div",{id:"recentlyPlayedList",ref:"recentlyPlayedList"},this.props.data.sort(function(a,b){return a.description<b.description?-1:a.description>b.description?1:0}).map(function(a){return React.createElement("span",null,React.createElement("a",{href:"#","data-url":a.url,onClick:a.playVideo},a.description),React.createElement("br",null))})))}}),m=React.createClass({displayName:"VideoPlayback",componentDidMount:function(){var a=this.refs.webview.getDOMNode();a.httpreferrer="http://www.youtube.com",a.addEventListener("new-window",function(a){d.openExternal(a.url)}),a.addEventListener("ipc-message",function(a){""!==a.channel&&(e.setTitle(a.channel.title),void 0!==this.state.updateTitle&&this.state.updateTitle(a.channel.title,a.channel.ytid))}.bind(this)),setInterval(function(){"visible"===a.style.visibility&&a.send("ping")}.bind(this),1e3)},componentWillReceiveProps:function(a){void 0!==this.props.updateTitle&&this.setState({updateTitle:this.props.updateTitle})},render:function(){return""!==this.props.title&&e.setTitle(this.props.title),React.createElement("div",null,React.createElement("webview",{id:"webview",ref:"webview",preload:"./build/ping.min.js",src:this.props.src,style:this.props.style}))}});return{init:function(){React.render(React.createElement(k,null),document.getElementById("ui"))}}}();$(document).ready(function(){Toby.init()});
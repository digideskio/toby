{"version":3,"sources":["../src/backend.es6"],"names":[],"mappings":"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","file":"backend.js","sourcesContent":["// backend.es6 - Backend code for Toby\r\n// Copyright (C) 2016 Frank Hale <frankhale@gmail.com>\r\n//\r\n// This program is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// This program is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with this program.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\nconst backend = (function() {\r\n\r\n  const _ = require(\"lodash\");\r\n  const path = require(\"path\");\r\n  const express = require(\"express\");\r\n  const favicon = require(\"serve-favicon\");\r\n  const logger = require(\"morgan\");\r\n  const cookieParser = require(\"cookie-parser\");\r\n  const bodyParser = require(\"body-parser\");\r\n  const expressApp = express();\r\n  const debug = require(\"debug\")(\"express-test:server\");\r\n  const http = require(\"http\");\r\n  const port = normalizePort(process.env.PORT || \"3000\");\r\n  const PEG = require(\"pegjs\");\r\n  const fs = require(\"fs\");\r\n  const youtubeSearch = require(\"youtube-search\");\r\n\r\n  let server, onReady, dataParser, browser, appPath;\r\n  let defaultWindowTitle = \"\";\r\n  let videoDataPath = \"\";\r\n  let videoData = [];\r\n  let numberOfMaxRecentlyPlayedVideos = 30;\r\n\r\n  var youtubeSearchOpts = {\r\n    maxResults: 25,\r\n    key: \"AIzaSyB7AFwYCoI6ypTTSB2vnXdOtAe4hu5nP1E\",\r\n    type: \"video\"\r\n  };\r\n\r\n  _.mixin({\r\n    'pluckMany': (data, columns) => {\r\n      return _.map(data, _.partialRight(_.pick, columns));\r\n    },\r\n    'findByValues': (collection, property, values) => {\r\n      return _.filter(collection, function(item) {\r\n        return _.contains(values, item[property]);\r\n      });\r\n    }\r\n  });\r\n\r\n  function normalizePort(val) {\r\n    let port = parseInt(val, 10);\r\n\r\n    if (isNaN(port)) {\r\n      return val;\r\n    }\r\n\r\n    if (port >= 0) {\r\n      return port;\r\n    }\r\n\r\n    return false;\r\n  }\r\n\r\n  function onError(error) {\r\n    if (error.syscall !== 'listen') {\r\n      throw error;\r\n    }\r\n\r\n    let bind = typeof port === 'string' ? 'Pipe ' + port : 'Port ' + port;\r\n\r\n    // handle specific listen errors with friendly messages\r\n    switch (error.code) {\r\n      case 'EACCES':\r\n        console.error(bind + ' requires elevated privileges');\r\n        process.exit(1);\r\n        break;\r\n      case 'EADDRINUSE':\r\n        console.error(bind + ' is already in use');\r\n        process.exit(1);\r\n        break;\r\n      default:\r\n        throw error;\r\n    }\r\n  }\r\n\r\n  function onListening() {\r\n    var addr = server.address();\r\n    var bind = typeof addr === 'string' ? 'pipe ' + addr : 'port ' + addr.port;\r\n    debug('Listening on ' + bind);\r\n\r\n    if (onReady !== undefined || onReady !== null) {\r\n      onReady();\r\n    }\r\n  }\r\n\r\n  function createDataFileString(data) {\r\n    let results = [];\r\n\r\n    _.forEach(data, function(group) {\r\n      results.push(`${group.group} {`);\r\n\r\n      _.forEach(group.entries, function(entry) {\r\n        results.push(`\\t${entry.title} : ${entry.ytid}`);\r\n      });\r\n\r\n      results.push(\"}\\n\");\r\n    });\r\n\r\n    return results.join(\"\\n\");\r\n  }\r\n\r\n  function readDataFile() {\r\n    let dataRaw = fs.readFileSync(videoDataPath, 'utf8');\r\n\r\n    try {\r\n      videoData = dataParser.parse(dataRaw);\r\n    } catch (e) {\r\n      console.log(`Error parsing data file: ${e}`);\r\n    }\r\n  }\r\n\r\n  function writeDataFile(dataString) {\r\n    try {\r\n      fs.writeFileSync(videoDataPath, dataString, 'utf8');\r\n    } catch (e) {\r\n      console.log(`Error writing data file: ${e}`);\r\n    }\r\n  }\r\n\r\n  function initRoutes(appPath) {\r\n    expressApp.get(\"/\", (req, res, next) => {\r\n      res.render('index', {\r\n        title: defaultWindowTitle\r\n      });\r\n    });\r\n\r\n    expressApp.get(\"/api/data\", (req, res, next) => {\r\n      res.json(videoData);\r\n    });\r\n\r\n    expressApp.get(\"/api/search/:term\", function(req, res, next) {\r\n      let searchTerm = decodeURIComponent(req.params.term);\r\n      const flattenedVideos = _.flatten(_.pluckMany(videoData, [\"entries\"]).map((x) => {\r\n        return x.entries\r\n      }));\r\n      //console.log(`searchTerm (backend) = ${searchTerm}`);\r\n\r\n      if (searchTerm.startsWith(\"yt:\")) {\r\n        searchTerm = searchTerm.replace(\"yt:\", \"\").trim().toLowerCase();\r\n\r\n        youtubeSearch(searchTerm, youtubeSearchOpts, function(err, results) {\r\n          if (err) return console.log(err);\r\n\r\n          var finalResults = [];\r\n\r\n          _.forEach(results, function(r) {\r\n            finalResults.push({\r\n              title: r.title,\r\n              ytid: r.id\r\n            });\r\n          });\r\n\r\n          res.json(finalResults);\r\n        });\r\n      } else if (searchTerm.startsWith(\"g:\")) {\r\n        searchTerm = searchTerm.replace(\"g:\", \"\").trim().toLowerCase();\r\n\r\n        if (searchTerm === \"all\") {\r\n          res.json(flattenedVideos);\r\n        } else {\r\n          let group = _.find(videoData, function(g) {\r\n            return g.group.toLowerCase() === searchTerm;\r\n          });\r\n          res.json((group !== undefined) ? group.entries : []);\r\n        }\r\n      } else {\r\n        let results = [];\r\n\r\n        let groupsWithoutRecentlyPlayed = _.filter(videoData, function(g) {\r\n          return g.group.toLowerCase() !== \"recently played\";\r\n        });\r\n\r\n        let videosWithoutRecentlyPlayed = _.flatten(_.pluckMany(groupsWithoutRecentlyPlayed, [\"entries\"]).map((x) => {\r\n          return x.entries\r\n        }));\r\n\r\n        _.forEach(videosWithoutRecentlyPlayed, function(v) {\r\n          if (v.title.toLowerCase().indexOf(searchTerm.trim().toLowerCase()) > -1) {\r\n            results.push(v);\r\n          }\r\n        });\r\n        res.json(results);\r\n      }\r\n    });\r\n\r\n    // expressApp.get(\"/api/getDataFileString\", (req, res, next) => {\r\n    //   res.json({\r\n    //     dataFileString: createDataFileString(videoData)\r\n    //   });\r\n    // });\r\n\r\n    expressApp.post(\"/api/add\", function(req, res, next) {\r\n      let result = {}\r\n\r\n      if (req.body.title !== undefined && req.body.title.length > 0 &&\r\n        req.body.ytid !== undefined && req.body.ytid.length > 0) {\r\n        result.title = req.body.title;\r\n        result.ytid = req.body.ytid;\r\n\r\n        let group = \"misc\";\r\n        if (req.body.group !== undefined || req.body.group.length > 0) {\r\n          group = req.body.group;\r\n        }\r\n\r\n        const flattenedVideos = _.flatten(_.pluckMany(videoData, [\"entries\"]).map((x) => {\r\n          return x.entries\r\n        }));\r\n        let foundVideo = _.find(flattenedVideos, {\r\n          \"ytid\": req.body.ytid\r\n        });\r\n\r\n        if ((!foundVideo) || (group.toLowerCase() === \"recently played\")) {\r\n          let foundGroup = _.find(videoData, {\r\n            \"group\": group\r\n          });\r\n          if (foundGroup === undefined) {\r\n            videoData.push({\r\n              group: group,\r\n              entries: []\r\n            });\r\n            foundGroup = _.find(videoData, {\r\n              \"group\": group\r\n            });\r\n          }\r\n\r\n          result.status = `${req.body.title} added`;\r\n\r\n          foundGroup.entries.push({\r\n            title: req.body.title.replace(\":\", \"\"), // TODO: we need a more strict replace here...\r\n            // colons will fuck shit up! There are other\r\n            // chars that will trip the parser as well\r\n            ytid: req.body.ytid\r\n          });\r\n\r\n          if (group.toLowerCase() === \"recently played\") {\r\n            // trim to 30 video entries\r\n            foundGroup = _.takeRight(_.uniq(foundGroup), numberOfMaxRecentlyPlayedVideos);\r\n          }\r\n\r\n          writeDataFile(createDataFileString(videoData));\r\n\r\n        } else {\r\n          result.status = `${req.body.title} already in data file`;\r\n        }\r\n      } else {\r\n        result.status = \"title and ytid are required and cannot be empty\";\r\n      }\r\n\r\n      res.json(result);\r\n    });\r\n\r\n    expressApp.post(\"/api/title\", (req, res, next) => {\r\n      if (req.body.title !== \"\") {\r\n        browser.setTitle(req.body.title);\r\n      }\r\n\r\n      res.json({\r\n        status: \"title changed\",\r\n        title: req.body.title\r\n      });\r\n    });\r\n\r\n    expressApp.post(\"/api/resetWindowTitleToDefault\", (req, res, next) => {\r\n      browser.setTitle(defaultWindowTitle);\r\n\r\n      res.json({\r\n        status: \"title changed\",\r\n        title: defaultWindowTitle\r\n      });\r\n    });\r\n  }\r\n\r\n  function init(onReadyCallback, appPath, currentWindow) {\r\n    onReady = onReadyCallback;\r\n    this.appPath = appPath;\r\n    videoDataPath = `${appPath}/data/data.txt`;\r\n    dataParser = PEG.buildParser(fs.readFileSync(`${appPath}/data/data-grammar.txt`, 'utf8'));\r\n    browser = currentWindow;\r\n    defaultWindowTitle = browser.getTitle();\r\n\r\n    readDataFile();\r\n\r\n    // view engine setup\r\n    expressApp.set('views', path.join(appPath, 'views'));\r\n    expressApp.set('view engine', 'jade');\r\n\r\n    // uncomment after placing your favicon in /public\r\n    //app.use(favicon(path.join(app.getAppPath(), 'public', 'favicon.ico')));\r\n    expressApp.use(logger('dev'));\r\n    expressApp.use(bodyParser.json());\r\n    expressApp.use(bodyParser.urlencoded({\r\n      extended: false\r\n    }));\r\n    expressApp.use(cookieParser());\r\n    expressApp.use(express.static(path.join(appPath, 'public')));\r\n    expressApp.set('port', port);\r\n\r\n    fs.watch(videoDataPath, (event, filename) => {\r\n      readDataFile();\r\n    });\r\n\r\n    initRoutes(appPath);\r\n\r\n    expressApp.use(function(req, res, next) {\r\n      var err = new Error(`Not Found : ${req.path}`);\r\n      err.status = 404;\r\n      next(err);\r\n    });\r\n\r\n    // development error handler\r\n    // will print stacktrace\r\n    if (expressApp.get('env') === 'development') {\r\n      expressApp.use(function(err, req, res, next) {\r\n        res.status(err.status || 500);\r\n        res.render('error', {\r\n          message: err.message,\r\n          error: err\r\n        });\r\n      });\r\n    }\r\n\r\n    // production error handler\r\n    // no stacktraces leaked to user\r\n    expressApp.use(function(err, req, res, next) {\r\n      res.status(err.status || 500);\r\n      res.render('error', {\r\n        message: err.message,\r\n        error: {}\r\n      });\r\n    });\r\n\r\n    server = http.createServer(expressApp);\r\n    server.listen(port);\r\n    server.on('error', onError);\r\n    server.on('listening', onListening);\r\n  }\r\n\r\n  function close() {\r\n    server.close();\r\n  }\r\n\r\n  return {\r\n    init: init,\r\n    close: close\r\n  }\r\n})();\r\n\r\nmodule.exports = backend;\r\n"]}
/*! Toby 2016-03-02 */
"use strict";function _typeof(a){return a&&"undefined"!=typeof Symbol&&a.constructor===Symbol?"symbol":typeof a}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!b||"object"!=typeof b&&"function"!=typeof b?a:b}function _inherits(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var _createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),Toby=function(){_.mixin({pluckMany:function(a,b){return _.map(a,_.partialRight(_.pick,b))},findByValues:function(a,b,c){return _.filter(a,function(a){return _.contains(c,a[b])})}});var a=3e3,b=function(a){function b(){_classCallCheck(this,b);var a=_possibleConstructorReturn(this,Object.getPrototypeOf(b).call(this));return a.onCommandInputKeyUp=a.onCommandInputKeyUp.bind(a),a.onCommandInputChanged=a.onCommandInputChanged.bind(a),a.keys={Enter:13,Up:38,Down:40},a.state={commandIndex:-1,commandsEntered:[]},a}return _inherits(b,a),_createClass(b,[{key:"componentDidMount",value:function(){function a(){b.width(window.innerWidth-50)}var b=$("#commandText");this.setState({commandText:b}),a(),$(window).resize(function(b){a()})}},{key:"onCommandInputKeyUp",value:function(a){var b=this;if(a.which===this.keys.Up)!function(){var a=-1===b.state.commandIndex?b.state.commandsEntered.length-1:--b.state.commandIndex;0>a&&(a=0),b.setState({commandIndex:a},function(){this.state.commandText.val(this.state.commandsEntered[a])})}();else if(a.which===this.keys.Down)!function(){var a=-1===b.state.commandIndex?0:++b.state.commandIndex;a>b.state.commandsEntered.length&&(a=b.state.commandsEntered.length),b.setState({commandIndex:a},function(){this.state.commandText.val(this.state.commandsEntered[a])})}();else if(a.which===this.keys.Enter){var c=function(){var a=b.state.commandText.val();return a.length>0?void b.setState({commandsEntered:_.uniq(b.state.commandsEntered.concat([a])),commandIndex:-1},function(){void 0!==this.props.onKeyEnter&&this.props.onKeyEnter(a)}):{v:void 0}}();if("object"===("undefined"==typeof c?"undefined":_typeof(c)))return c.v}}},{key:"onCommandInputChanged",value:function(a){var b=this.state.commandText.val();void 0!==this.props.onKeyChanged&&this.props.onKeyChanged(b)}},{key:"render",value:function(){return React.createElement("div",{id:"commandContainer",className:"command-container"},">",React.createElement("input",{id:"commandText",className:"command-input",type:"text",onKeyUp:this.onCommandInputKeyUp,onChange:this.onCommandInputChanged,autoFocus:!0,placeholder:"Search YouTube or your saved videos..."}))}}]),b}(React.Component),c=function(a){function b(){_classCallCheck(this,b);var a=_possibleConstructorReturn(this,Object.getPrototypeOf(b).call(this));return a.state={data:[]},a}return _inherits(b,a),_createClass(b,[{key:"componentWillReceiveProps",value:function(a){void 0!==a.data&&this.setState({data:a.data})}},{key:"componentDidMount",value:function(){var a=function(){$(".highlightRow").css("width",window.innerWidth-25),$(".videoTitle").css("width",window.innerWidth-200)};window.addEventListener("resize",function(b){a()})}},{key:"render",value:function(){var a=this,b={width:window.innerWidth-25},c={width:window.innerWidth-200};return React.createElement("div",{className:"content-panel"},this.state.data.map(function(d,e){return React.createElement("div",{className:"highlightRow",style:b,onClick:d.playVideo.bind(a,d)},React.createElement("div",{className:"alignDiv videoThumbnail"},React.createElement("img",{src:d.thumbnail})),React.createElement("div",{className:"alignDiv videoTitle",style:c},d.title))}))}}]),b}(React.Component),d=function(b){function c(){_classCallCheck(this,c);var a=_possibleConstructorReturn(this,Object.getPrototypeOf(c).call(this));return a.state=a.initialState(),a}return _inherits(c,b),_createClass(c,[{key:"initialState",value:function(){return{message:"",notificationStyle:{display:"none"}}}},{key:"componentWillReceiveProps",value:function(b){void 0!==b.message&&b.message.length>0&&this.setState({message:b.message,notificationStyle:{display:"block"}},function(){setTimeout(function(){this.setState(this.initialState)}.bind(this),a)}.bind(this))}},{key:"render",value:function(){return React.createElement("div",{className:"videoAddedNotification",style:this.state.notificationStyle},this.state.message)}}]),c}(React.Component),e=function(e){function f(){_classCallCheck(this,f);var a=_possibleConstructorReturn(this,Object.getPrototypeOf(f).call(this));return a.onCommandEntered=a.onCommandEntered.bind(a),a.onCommandChanged=a.onCommandChanged.bind(a),a.state={commands:[],searchResults:[],videoInfo:{},videoAddedNotification:""},a}return _inherits(f,e),_createClass(f,[{key:"onCommandEntered",value:function(a){$.ajax({url:"/api/search/"+encodeURIComponent(a),cache:!1}).done(function(b){var c=this.state.commands;c.push(a),this.state.player.stopVideo(),$("#player").css("display","none"),$.ajax({type:"POST",url:"/api/resetWindowTitleToDefault"}),this.setState({commands:c,searchResults:this.buildResults(b)})}.bind(this))}},{key:"onCommandChanged",value:function(a){return a.length>0?void 0:(this.setState({searchResults:[]}),this.state.player.stopVideo(),$("#player").css("display","none"),void $.ajax({type:"POST",url:"/api/resetWindowTitleToDefault"}))}},{key:"componentDidMount",value:function(){this.initKeyBindings();var a=document.createElement("script");a.src="https://www.youtube.com/iframe_api";var b=document.getElementsByTagName("script")[0];b.parentNode.insertBefore(a,b);var c;window.onYouTubeIframeAPIReady=function(){c=new YT.Player("player",{playerVars:{autoplay:1,autohide:1},events:{onReady:d,onStateChange:e}}),$(window.frames[0].document).on("keydown",function(a){$(top.document).trigger("keydown",a)}),this.setState({player:c})}.bind(this);var d=function(a){$(window.frames[0].document).on("keydown",function(a){$(top.document).trigger(a)}),c.setVolume(30)},e=function(a){var b=a.target.getVideoData();""===b.title||void 0!==this.state.videoInfo.title&&this.state.videoInfo.title===b.title||this.setState({videoInfo:b},function(){$.ajax({type:"POST",url:"/api/title",data:{title:b.title}})})}.bind(this)}},{key:"initKeyBindings",value:function(){$(document).on("keydown",function(b){var c=b.keyCode||b.which;116===c?_.isEmpty(this.state.videoInfo)||$.ajax({url:"/api/add",type:"POST",data:{title:this.state.videoInfo.title,ytid:this.state.videoInfo.video_id,group:"misc"},success:function(b){this.setState({videoAddedNotification:b.status},function(){setTimeout(function(){this.setState({videoAddedNotification:""})}.bind(this),a)}.bind(this))}.bind(this)}):117===c?$("#player").contents().find(".html5-main-video").css("-webkit-filter","grayscale(1)"):118===c?$("#player").contents().find(".html5-main-video").css("-webkit-filter","saturate(2.5)"):119===c?$("#player").contents().find(".html5-main-video").css("-webkit-filter","sepia(1)"):120===c&&$("#player").contents().find(".html5-main-video").css("-webkit-filter","")}.bind(this))}},{key:"buildResults",value:function(a){var b=[];return _.forEach(a,function(a){b.push({player:this.state.player,playVideo:this.playVideo.bind(this),title:a.title,ytid:a.ytid,thumbnail:"https://i.ytimg.com/vi/"+a.ytid+"/default.jpg"})}.bind(this)),b}},{key:"playVideo",value:function(a){this.state.player.loadVideoById(a.ytid),$("#player").css("display","block"),$("html, body").animate({scrollTop:$("#player").offset().top},250),$.ajax({type:"POST",url:"/api/title",data:{title:a.title}}),$.ajax({url:"/api/add",type:"POST",data:{title:a.title,ytid:a.ytid,group:"Recently Played"}})}},{key:"render",value:function(){return React.createElement("div",null,React.createElement(d,{message:this.state.videoAddedNotification}),React.createElement(b,{onKeyEnter:this.onCommandEntered,onKeyChanged:this.onCommandChanged}),React.createElement(c,{data:this.state.searchResults}),React.createElement("div",{id:"player"}))}}]),f}(React.Component);return{init:function(){ReactDOM.render(React.createElement(e,null),document.getElementById("ui"))}}}();$(document).ready(function(){Toby.init()});
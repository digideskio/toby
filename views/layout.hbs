<!DOCTYPE html>
<html>
  <head>
    <title>{{title}}</title>
    <link rel="stylesheet" href="/stylesheets/style.css" />
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=VT323" />

    <script src="/components/jquery/dist/jquery.min.js"></script>
    <script src="/components/lodash/dist/lodash.min.js"></script>
    <script src="/components/react/react.min.js"></script>
    <script src="/components/react/react-dom.min.js"></script>
    <script src="/components/keymaster/keymaster.js"></script>

    <script>
      if(navigator.userAgent.includes("nwjs")) {
        // Really wish I could do all this stuff in node-main
        var win = nw.Window.get();
        var socket = require("socket.io")(62375);

        socket.on("connection", function() {
          console.log("Socket.IO connection established...");
        });

        win.on("loaded", function() {
         win.showDevTools();
        });

        win.on('new-win-policy', function(frame, url, policy){
          policy.ignore();

          // Looks like we can differentiate between clicking the YouTube icon
          // in the player where we want it to open an external browser and clicking
          // a suggested video link after a video is played.
          //
          // When clicking the YouTube link "time_continue" is present in the url.
          // {url: "https://www.youtube.com/watch?time_continue=1&v=ctrZdbExVrk"}
          //
          // When clicking on a suggested video the link is just an ordinary YouTube
          // video link with video ID.
          // {url: "https://www.youtube.com/watch?v=4nYMdMtGsPo"}

          console.log("---");
          console.log(url);
          console.log("---")

          if(url.includes("time_continue")) {
            nw.Shell.openExternal(url);
          } else if(url.includes("?v=")) {
            // the id extraction is almost verbatim from:
            // http://stackoverflow.com/a/3452617/170217
            var video_id = url.split('v=')[1];
            var ampersandPosition = video_id.indexOf('&');
            if(ampersandPosition != -1) {
              video_id = video_id.substring(0, ampersandPosition);
            }
            //------------------------------------------

            console.log(`emitting: play-video for ${video_id}`);

            socket.emit("play-video", {
              url: url,
              ytid: video_id
            });
          }
        });
      }
    </script>
  </head>
  <body>
    {{{body}}}
  </body>
</html>
